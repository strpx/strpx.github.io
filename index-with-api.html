<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∏≠„Åè„ÅòÂºï„Åç„Ç¢„Éó„É™ - „É™„Ç¢„É´„Çø„Ç§„É†ÂÖ±Êúâ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* ÁîªÈù¢Âàá„ÇäÊõø„Åà */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* „Ç´„Éº„Éâ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: #4CAF50;
            color: white;
            width: auto;
            margin-left: 10px;
        }

        .btn-large {
            padding: 20px;
            font-size: 1.2rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Âå∫Âàá„ÇäÁ∑ö */
        .divider {
            text-align: center;
            color: white;
            margin: 20px 0;
            font-weight: 700;
        }

        /* „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†± */
        .session-info {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .session-info h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .session-info p {
            margin: 5px 0;
        }

        /* ÊäΩÈÅ∏„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .draw-animation {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .draw-animation.active {
            display: block;
        }

        .roulette {
            margin: 0 auto 20px;
            width: 200px;
            height: 200px;
            border: 8px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        .roulette-number {
            font-size: 4rem;
            font-weight: 700;
            color: #667eea;
            animation: spin 0.1s linear infinite;
        }

        .animation-text {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 700;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes spin {
            from {
                transform: rotateY(0deg);
            }
            to {
                transform: rotateY(360deg);
            }
        }

        /* ÁµêÊûú„Ç´„Éº„Éâ */
        .result-card {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s;
        }

        .result-card.active {
            display: block;
        }

        .result-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .seat-number {
            font-size: 5rem;
            font-weight: 700;
            color: #764ba2;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .result-name {
            font-size: 1.5rem;
            color: #555;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ÁµêÊûú„É™„Çπ„Éà */
        .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-badge {
            background: #ff4444;
            color: white;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% {
                opacity: 1;
            }
            25%, 75% {
                opacity: 0.5;
            }
        }

        .results-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            animation: slideIn 0.3s;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item-name {
            font-weight: 700;
            color: #333;
        }

        .result-item-seat {
            font-size: 1.5rem;
            font-weight: 700;
            color: #764ba2;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 600px) {
            header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .seat-number {
                font-size: 3.5rem;
            }

            .roulette {
                width: 150px;
                height: 150px;
            }

            .roulette-number {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé≤ Â∏≠„Åè„ÅòÂºï„Åç„Ç¢„Éó„É™</h1>
            <p class="subtitle">„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÁµêÊûú„ÇíÂÖ±Êúâ„Åß„Åç„Åæ„Åô</p>
        </header>

        <!-- „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†± -->
        <div id="debugInfo" style="background: rgba(255,255,255,0.9); padding: 10px; margin-bottom: 10px; border-radius: 8px; display: none; font-size: 0.85rem; max-height: 300px; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>üîç „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ</strong>
                <button onclick="clearDebug()" style="padding: 5px 10px; font-size: 0.8rem;">„ÇØ„É™„Ç¢</button>
            </div>
            <div id="debugContent" style="font-family: monospace; white-space: pre-wrap;"></div>
        </div>

        <!-- „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„ÉªÂèÇÂä†ÁîªÈù¢ -->
        <div id="setupScreen" class="screen active">
            <div class="card">
                <h2>Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê</h2>
                <div class="form-group">
                    <label for="sessionName">„Çª„ÉÉ„Ç∑„Éß„É≥Âêç</label>
                    <input type="text" id="sessionName" placeholder="‰æã: 2025Âπ¥Â∫¶ Á¨¨1Âõû„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞" />
                </div>
                <div class="form-group">
                    <label for="totalSeats">Â∏≠„ÅÆÊï∞</label>
                    <input type="number" id="totalSeats" min="2" max="100" value="10" />
                </div>
                <button class="btn btn-primary" onclick="createSession()">„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê</button>
            </div>

            <div class="divider">„Åæ„Åü„ÅØ</div>

            <div class="card">
                <h2>Êó¢Â≠ò„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Å´ÂèÇÂä†</h2>
                <div class="form-group">
                    <label for="sessionId">„Çª„ÉÉ„Ç∑„Éß„É≥ID</label>
                    <input type="text" id="sessionId" placeholder="„Çª„ÉÉ„Ç∑„Éß„É≥ID„ÇíÂÖ•Âäõ" />
                </div>
                <button class="btn btn-secondary" onclick="joinSession()">„Çª„ÉÉ„Ç∑„Éß„É≥ÂèÇÂä†</button>
            </div>
        </div>

        <!-- „Åè„ÅòÂºï„ÅçÁîªÈù¢ -->
        <div id="drawScreen" class="screen">
            <div class="session-info">
                <h2 id="currentSessionName"></h2>
                <p>„Çª„ÉÉ„Ç∑„Éß„É≥ID: <strong id="currentSessionId"></strong></p>
                <p>Â∏≠Êï∞: <strong id="currentTotalSeats"></strong></p>
                <button class="btn btn-small btn-copy" onclick="copySessionId()">üìã ID„Çí„Ç≥„Éî„Éº</button>
            </div>

            <div class="card">
                <h2>„Åè„ÅòÂºï„Åç„ÇíÂÆüË°å</h2>
                <div class="form-group">
                    <label for="participantName">ÂêçÂâç</label>
                    <input type="text" id="participantName" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ" />
                </div>
                <button class="btn btn-primary btn-large" onclick="drawSeat()" id="drawButton">
                    üéØ „Åè„Åò„ÇíÂºï„Åè
                </button>
            </div>

            <!-- ÊäΩÈÅ∏„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ -->
            <div id="drawAnimation" class="draw-animation">
                <div class="roulette">
                    <div class="roulette-number" id="rouletteNumber">?</div>
                </div>
                <p class="animation-text">ÊäΩÈÅ∏‰∏≠...</p>
            </div>

            <!-- ÁµêÊûúË°®Á§∫ -->
            <div id="resultCard" class="result-card">
                <div class="result-content">
                    <h2>üéâ „ÅÇ„Å™„Åü„ÅÆÂ∏≠Áï™Âè∑</h2>
                    <div class="seat-number" id="resultSeatNumber">-</div>
                    <p class="result-name" id="resultName"></p>
                </div>
            </div>

            <!-- „É™„Ç¢„É´„Çø„Ç§„É†ÁµêÊûú„É™„Çπ„Éà -->
            <div class="results-section">
                <h2>üìä ÊäΩÈÅ∏ÁµêÊûú <span class="live-badge">LIVE</span></h2>
                <div id="resultsList" class="results-list">
                    <p class="empty-message">„Åæ„Å†Ë™∞„ÇÇ„Åè„Åò„ÇíÂºï„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="backToSetup()">‚Üê „Çª„ÉÉ„Ç∑„Éß„É≥ÈÅ∏Êäû„Å´Êàª„Çã</button>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentSession = null;
        let pollingInterval = null;
        let usedSeats = new Set();
        let debugMode = false;

        // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±Ë°®Á§∫
        function showDebug(message) {
            console.log(message);
            if (debugMode) {
                const debugDiv = document.getElementById('debugInfo');
                const debugContent = document.getElementById('debugContent');
                debugDiv.style.display = 'block';
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += timestamp + ': ' + message + '\n';
                // Ëá™Âãï„Çπ„ÇØ„É≠„Éº„É´
                debugContent.scrollTop = debugContent.scrollHeight;
            }
        }

        function clearDebug() {
            document.getElementById('debugContent').innerHTML = '';
        }

        // URL„Éë„É©„É°„Éº„Çø„Åß„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        if (window.location.search.includes('debug=true')) {
            debugMode = true;
            showDebug('„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„ÉâÊúâÂäπ');
        }

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£: „É©„É≥„ÉÄ„É†„Å™ID„ÇíÁîüÊàê
        function generateId() {
            return 'sess_' + Math.random().toString(36).substring(2, 15);
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
        async function createSession() {
            const sessionName = document.getElementById('sessionName').value.trim();
            const totalSeats = parseInt(document.getElementById('totalSeats').value);

            if (!sessionName) {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (totalSeats < 2 || totalSeats > 100) {
                alert('Â∏≠„ÅÆÊï∞„ÅØ2„Äú100„ÅÆÁØÑÂõ≤„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const sessionId = generateId();
            const sessionData = {
                session_id: sessionId,
                session_name: sessionName,
                total_seats: totalSeats,
                status: 'active'
            };

            console.log('Creating session:', sessionData);

            try {
                showDebug('„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàêÈñãÂßã: ' + JSON.stringify(sessionData));
                
                const response = await fetch('/tables/sessions', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(sessionData)
                });

                showDebug('Response status: ' + response.status);
                
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    showDebug('Non-JSON response: ' + text);
                    result = { error: '„Çµ„Éº„Éê„Éº„Åã„Çâ‰∫àÊúü„Åó„Å™„ÅÑ„É¨„Çπ„Éù„É≥„Çπ: ' + text };
                }
                
                showDebug('Response data: ' + JSON.stringify(result));

                if (response.ok) {
                    currentSession = result;
                    showDrawScreen();
                } else {
                    const errorMsg = result.error || result.message || JSON.stringify(result);
                    console.error('Session creation failed:', errorMsg);
                    alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n\n' + errorMsg + '\n\n„Çπ„ÉÜ„Éº„Çø„Çπ: ' + response.status + '\n\n„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅßË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàURLÊú´Â∞æ„Å´?debug=trueÔºâ');
                }
            } catch (error) {
                console.error('Error creating session:', error);
                showDebug('Exception: ' + error.message + '\n' + error.stack);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:\n\n' + error.message + '\n\n„Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅßË©≥Á¥∞„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàURLÊú´Â∞æ„Å´?debug=trueÔºâ');
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÂèÇÂä†
        async function joinSession() {
            const sessionId = document.getElementById('sessionId').value.trim();

            if (!sessionId) {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            console.log('Joining session:', sessionId);

            try {
                showDebug('„Çª„ÉÉ„Ç∑„Éß„É≥Ê§úÁ¥¢ÈñãÂßã: ' + sessionId);
                
                const response = await fetch(`/tables/sessions?search=${sessionId}&limit=100`);
                
                let data;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error('„Çµ„Éº„Éê„Éº„Åã„Çâ‰∫àÊúü„Åó„Å™„ÅÑ„É¨„Çπ„Éù„É≥„Çπ: ' + text);
                }
                
                showDebug('Search results: ' + JSON.stringify(data));

                if (data.data && data.data.length > 0) {
                    // session_id„Åß„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                    const session = data.data.find(s => s.session_id === sessionId);
                    if (session) {
                        currentSession = session;
                        showDrawScreen();
                    } else {
                        alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü\n\nÂÖ•Âäõ„Åó„ÅüID: ' + sessionId + '\n\nÊ§úÁ¥¢ÁµêÊûú: ' + data.data.length + '‰ª∂');
                    }
                } else {
                    alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü\n\nÂÖ•Âäõ„Åó„ÅüID: ' + sessionId);
                }
            } catch (error) {
                console.error('Error joining session:', error);
                showDebug('Join exception: ' + error.message);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:\n\n' + error.message);
            }
        }

        // „Åè„ÅòÂºï„ÅçÁîªÈù¢„ÇíË°®Á§∫
        function showDrawScreen() {
            console.log('Showing draw screen with session:', currentSession);
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('drawScreen').classList.add('active');

            document.getElementById('currentSessionName').textContent = currentSession.session_name;
            document.getElementById('currentSessionId').textContent = currentSession.session_id;
            document.getElementById('currentTotalSeats').textContent = currentSession.total_seats;

            // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„ÇíÈñãÂßã
            startPolling();
            loadResults();
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ID„Çí„Ç≥„Éî„Éº
        function copySessionId() {
            const sessionId = currentSession.session_id;
            navigator.clipboard.writeText(sessionId).then(() => {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥ID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            }).catch(err => {
                console.error('Clipboard error:', err);
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éó„É≠„É≥„Éó„Éà„ÅßË°®Á§∫
                prompt('„Çª„ÉÉ„Ç∑„Éß„É≥ID„Çí„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', sessionId);
            });
        }

        // „Åè„ÅòÂºï„ÅçÂÆüË°å
        async function drawSeat() {
            const participantName = document.getElementById('participantName').value.trim();

            if (!participantName) {
                alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            const drawButton = document.getElementById('drawButton');
            drawButton.disabled = true;

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            showDrawAnimation();

            // Âà©Áî®ÂèØËÉΩ„Å™Â∏≠Áï™Âè∑„ÇíÂèñÂæó
            await loadUsedSeats();
            const availableSeats = [];
            for (let i = 1; i <= currentSession.total_seats; i++) {
                if (!usedSeats.has(i)) {
                    availableSeats.push(i);
                }
            }

            if (availableSeats.length === 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÂ∏≠„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô');
                hideDrawAnimation();
                drawButton.disabled = false;
                return;
            }

            // „É©„É≥„ÉÄ„É†„Å´Â∏≠„ÇíÈÅ∏Êäû
            const randomIndex = Math.floor(Math.random() * availableSeats.length);
            const selectedSeat = availableSeats[randomIndex];

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊºîÂá∫Ôºà2ÁßíÈñì = 20Âõû √ó 100msÔºâ
            let counter = 0;
            const animationInterval = setInterval(() => {
                const randomNum = Math.floor(Math.random() * currentSession.total_seats) + 1;
                document.getElementById('rouletteNumber').textContent = randomNum;
                counter++;
                if (counter >= 20) {  // 2Áßí„ÅßÁµÇ‰∫Ü
                    clearInterval(animationInterval);
                    finalizeDraw(participantName, selectedSeat);
                }
            }, 100);
        }

        // „Åè„ÅòÂºï„ÅçÁ¢∫ÂÆö
        async function finalizeDraw(participantName, seatNumber) {
            const assignmentData = {
                session_id: currentSession.session_id,
                participant_name: participantName,
                seat_number: seatNumber
            };

            console.log('Saving assignment:', assignmentData);

            try {
                showDebug('„Åè„ÅòÂºï„Åç‰øùÂ≠òÈñãÂßã: ' + JSON.stringify(assignmentData));
                
                const response = await fetch('/tables/seat_assignments', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(assignmentData)
                });

                showDebug('Assignment response status: ' + response.status);
                
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    result = { error: '„Çµ„Éº„Éê„Éº„Åã„Çâ‰∫àÊúü„Åó„Å™„ÅÑ„É¨„Çπ„Éù„É≥„Çπ: ' + text };
                }
                
                showDebug('Assignment result: ' + JSON.stringify(result));

                if (response.ok) {
                    hideDrawAnimation();
                    showResult(participantName, seatNumber);
                    loadResults();

                    // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
                    document.getElementById('drawButton').disabled = false;
                    document.getElementById('participantName').value = '';
                } else {
                    const errorMsg = result.error || result.message || JSON.stringify(result);
                    alert('„Åè„ÅòÂºï„Åç„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:\n\n' + errorMsg);
                    hideDrawAnimation();
                    document.getElementById('drawButton').disabled = false;
                }
            } catch (error) {
                console.error('Error saving draw:', error);
                showDebug('Draw exception: ' + error.message);
                alert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü:\n\n' + error.message);
                hideDrawAnimation();
                document.getElementById('drawButton').disabled = false;
            }
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
        function showDrawAnimation() {
            document.getElementById('drawAnimation').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈùûË°®Á§∫
        function hideDrawAnimation() {
            document.getElementById('drawAnimation').classList.remove('active');
        }

        // ÁµêÊûúË°®Á§∫
        function showResult(name, seatNumber) {
            document.getElementById('resultName').textContent = name + ' „Åï„Çì';
            document.getElementById('resultSeatNumber').textContent = seatNumber;
            document.getElementById('resultCard').classList.add('active');
        }

        // ‰ΩøÁî®Ê∏à„ÅøÂ∏≠Áï™Âè∑„ÇíË™≠„ÅøËæº„Åø
        async function loadUsedSeats() {
            try {
                const response = await fetch(`/tables/seat_assignments?search=${currentSession.session_id}&limit=1000`);
                const data = await response.json();
                console.log('Used seats data:', data);

                usedSeats.clear();
                if (data.data) {
                    data.data.forEach(assignment => {
                        if (assignment.session_id === currentSession.session_id) {
                            usedSeats.add(assignment.seat_number);
                        }
                    });
                }
                console.log('Used seats:', Array.from(usedSeats));
            } catch (error) {
                console.error('Error loading used seats:', error);
            }
        }

        // ÁµêÊûú„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
        async function loadResults() {
            try {
                const response = await fetch(`/tables/seat_assignments?search=${currentSession.session_id}&limit=1000&sort=-drawn_at`);
                const data = await response.json();
                console.log('Results data:', data);

                const resultsList = document.getElementById('resultsList');
                
                if (!data.data || data.data.length === 0) {
                    resultsList.innerHTML = '<p class="empty-message">„Åæ„Å†Ë™∞„ÇÇ„Åè„Åò„ÇíÂºï„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }

                // „Çª„ÉÉ„Ç∑„Éß„É≥„Å´Èñ¢ÈÄ£„Åô„ÇãÁµêÊûú„ÅÆ„Åø„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
                const sessionResults = data.data.filter(item => item.session_id === currentSession.session_id);

                if (sessionResults.length === 0) {
                    resultsList.innerHTML = '<p class="empty-message">„Åæ„Å†Ë™∞„ÇÇ„Åè„Åò„ÇíÂºï„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                    return;
                }

                // Â∏≠Áï™Âè∑È†Ü„Å´„ÇΩ„Éº„Éà
                sessionResults.sort((a, b) => a.seat_number - b.seat_number);

                resultsList.innerHTML = sessionResults.map(item => `
                    <div class="result-item">
                        <span class="result-item-name">${escapeHtml(item.participant_name)}</span>
                        <span class="result-item-seat">Â∏≠ ${item.seat_number}</span>
                    </div>
                `).join('');

                // ‰ΩøÁî®Ê∏à„ÅøÂ∏≠„ÇíÊõ¥Êñ∞
                usedSeats.clear();
                sessionResults.forEach(item => {
                    usedSeats.add(item.seat_number);
                });

            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ÈñãÂßã
        function startPolling() {
            // Êó¢Â≠ò„ÅÆ„Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // 3Áßí„Åî„Å®„Å´ÁµêÊûú„ÇíÊõ¥Êñ∞
            pollingInterval = setInterval(() => {
                loadResults();
            }, 3000);
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ÂÅúÊ≠¢
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„Å´Êàª„Çã
        function backToSetup() {
            stopPolling();
            currentSession = null;
            usedSeats.clear();

            document.getElementById('drawScreen').classList.remove('active');
            document.getElementById('setupScreen').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
            document.getElementById('participantName').value = '';
        }

        // HTML„Ç®„Çπ„Ç±„Éº„Éó
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´„Éù„Éº„É™„É≥„Ç∞ÂÅúÊ≠¢
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });
    </script>
</body>
</html>
