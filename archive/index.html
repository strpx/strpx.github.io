<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸­ãã˜å¼•ãã‚¢ãƒ—ãƒª - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±æœ‰</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: #4CAF50;
            color: white;
            width: auto;
            margin-left: 10px;
        }

        .btn-large {
            padding: 20px;
            font-size: 1.2rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* åŒºåˆ‡ã‚Šç·š */
        .divider {
            text-align: center;
            color: white;
            margin: 20px 0;
            font-weight: 700;
        }

        /* ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ± */
        .session-info {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .session-info h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .session-info p {
            margin: 5px 0;
        }

        /* æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .draw-animation {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .draw-animation.active {
            display: block;
        }

        .roulette {
            margin: 0 auto 20px;
            width: 200px;
            height: 200px;
            border: 8px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        .roulette-number {
            font-size: 4rem;
            font-weight: 700;
            color: #667eea;
            animation: spin 0.1s linear infinite;
        }

        .animation-text {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 700;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes spin {
            from {
                transform: rotateY(0deg);
            }
            to {
                transform: rotateY(360deg);
            }
        }

        /* çµæœã‚«ãƒ¼ãƒ‰ */
        .result-card {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s;
        }

        .result-card.active {
            display: block;
        }

        .result-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .seat-number {
            font-size: 5rem;
            font-weight: 700;
            color: #764ba2;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .result-name {
            font-size: 1.5rem;
            color: #555;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* çµæœãƒªã‚¹ãƒˆ */
        .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-badge {
            background: #ff4444;
            color: white;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% {
                opacity: 1;
            }
            25%, 75% {
                opacity: 0.5;
            }
        }

        .results-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            animation: slideIn 0.3s;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item-name {
            font-weight: 700;
            color: #333;
        }

        .result-item-seat {
            font-size: 1.5rem;
            font-weight: 700;
            color: #764ba2;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .notice strong {
            display: block;
            margin-bottom: 5px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .seat-number {
                font-size: 3.5rem;
            }

            .roulette {
                width: 150px;
                height: 150px;
            }

            .roulette-number {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ² å¸­ãã˜å¼•ãã‚¢ãƒ—ãƒª</h1>
            <p class="subtitle">ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç‰ˆ</p>
        </header>

        <div class="notice">
            <strong>âš ï¸ æ³¨æ„äº‹é …</strong>
            ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»åŒã˜ãƒ‡ãƒã‚¤ã‚¹ã§ã®ã¿ãƒ‡ãƒ¼ã‚¿ãŒå…±æœ‰ã•ã‚Œã¾ã™ã€‚è¤‡æ•°ãƒ‡ãƒã‚¤ã‚¹ã§ã®å…±æœ‰ã¯ã§ãã¾ã›ã‚“ã€‚
        </div>

        <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ»å‚åŠ ç”»é¢ -->
        <div id="setupScreen" class="screen active">
            <div class="card">
                <h2>æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ</h2>
                <div class="form-group">
                    <label for="sessionName">ã‚»ãƒƒã‚·ãƒ§ãƒ³å</label>
                    <input type="text" id="sessionName" placeholder="ä¾‹: 2025å¹´åº¦ ç¬¬1å›ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°" />
                </div>
                <div class="form-group">
                    <label for="totalSeats">å¸­ã®æ•°</label>
                    <input type="number" id="totalSeats" min="2" max="100" value="10" />
                </div>
                <button class="btn btn-primary" onclick="createSession()">ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ</button>
            </div>

            <div class="divider">ã¾ãŸã¯</div>

            <div class="card">
                <h2>æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å‚åŠ </h2>
                <div class="form-group">
                    <label for="sessionId">ã‚»ãƒƒã‚·ãƒ§ãƒ³ID</label>
                    <input type="text" id="sessionId" placeholder="ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å…¥åŠ›" />
                </div>
                <button class="btn btn-secondary" onclick="joinSession()">ã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ </button>
            </div>
        </div>

        <!-- ãã˜å¼•ãç”»é¢ -->
        <div id="drawScreen" class="screen">
            <div class="session-info">
                <h2 id="currentSessionName"></h2>
                <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: <strong id="currentSessionId"></strong></p>
                <p>å¸­æ•°: <strong id="currentTotalSeats"></strong></p>
                <button class="btn btn-small btn-copy" onclick="copySessionId()">ğŸ“‹ IDã‚’ã‚³ãƒ”ãƒ¼</button>
            </div>

            <div class="card">
                <h2>ãã˜å¼•ãã‚’å®Ÿè¡Œ</h2>
                <div class="form-group">
                    <label for="participantName">åå‰</label>
                    <input type="text" id="participantName" placeholder="ã‚ãªãŸã®åå‰ã‚’å…¥åŠ›" />
                </div>
                <button class="btn btn-primary btn-large" onclick="drawSeat()" id="drawButton">
                    ğŸ¯ ãã˜ã‚’å¼•ã
                </button>
            </div>

            <!-- æŠ½é¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div id="drawAnimation" class="draw-animation">
                <div class="roulette">
                    <div class="roulette-number" id="rouletteNumber">?</div>
                </div>
                <p class="animation-text">æŠ½é¸ä¸­...</p>
            </div>

            <!-- çµæœè¡¨ç¤º -->
            <div id="resultCard" class="result-card">
                <div class="result-content">
                    <h2>ğŸ‰ ã‚ãªãŸã®å¸­ç•ªå·</h2>
                    <div class="seat-number" id="resultSeatNumber">-</div>
                    <p class="result-name" id="resultName"></p>
                </div>
            </div>

            <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµæœãƒªã‚¹ãƒˆ -->
            <div class="results-section">
                <h2>ğŸ“Š æŠ½é¸çµæœ <span class="live-badge">LIVE</span></h2>
                <div id="resultsList" class="results-list">
                    <p class="empty-message">ã¾ã èª°ã‚‚ãã˜ã‚’å¼•ã„ã¦ã„ã¾ã›ã‚“</p>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="backToSetup()">â† ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentSession = null;
        let pollingInterval = null;
        let usedSeats = new Set();

        // LocalStorage ã‚­ãƒ¼
        const STORAGE_SESSIONS = 'lottery_sessions';
        const STORAGE_ASSIGNMENTS = 'lottery_assignments';

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ãƒ©ãƒ³ãƒ€ãƒ ãªIDã‚’ç”Ÿæˆ
        function generateId() {
            return 'sess_' + Math.random().toString(36).substring(2, 15);
        }

        // LocalStorage æ“ä½œ
        function getSessions() {
            const data = localStorage.getItem(STORAGE_SESSIONS);
            return data ? JSON.parse(data) : [];
        }

        function saveSessions(sessions) {
            localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(sessions));
        }

        function getAssignments() {
            const data = localStorage.getItem(STORAGE_ASSIGNMENTS);
            return data ? JSON.parse(data) : [];
        }

        function saveAssignments(assignments) {
            localStorage.setItem(STORAGE_ASSIGNMENTS, JSON.stringify(assignments));
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
        function createSession() {
            const sessionName = document.getElementById('sessionName').value.trim();
            const totalSeats = parseInt(document.getElementById('totalSeats').value);

            if (!sessionName) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            if (totalSeats < 2 || totalSeats > 100) {
                alert('å¸­ã®æ•°ã¯2ã€œ100ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„');
                return;
            }

            const sessionId = generateId();
            const session = {
                id: sessionId,
                session_id: sessionId,
                session_name: sessionName,
                total_seats: totalSeats,
                status: 'active',
                created_at: new Date().toISOString()
            };

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
            const sessions = getSessions();
            sessions.push(session);
            saveSessions(sessions);

            currentSession = session;
            showDrawScreen();
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‚åŠ 
        function joinSession() {
            const sessionId = document.getElementById('sessionId').value.trim();

            if (!sessionId) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const sessions = getSessions();
            const session = sessions.find(s => s.session_id === sessionId);

            if (session) {
                currentSession = session;
                showDrawScreen();
            } else {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ\n\nID: ' + sessionId);
            }
        }

        // ãã˜å¼•ãç”»é¢ã‚’è¡¨ç¤º
        function showDrawScreen() {
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('drawScreen').classList.add('active');

            document.getElementById('currentSessionName').textContent = currentSession.session_name;
            document.getElementById('currentSessionId').textContent = currentSession.session_id;
            document.getElementById('currentTotalSeats').textContent = currentSession.total_seats;

            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
            startPolling();
            loadResults();
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ã‚³ãƒ”ãƒ¼
        function copySessionId() {
            const sessionId = currentSession.session_id;
            navigator.clipboard.writeText(sessionId).then(() => {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
            }).catch(err => {
                prompt('ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', sessionId);
            });
        }

        // ãã˜å¼•ãå®Ÿè¡Œ
        async function drawSeat() {
            const participantName = document.getElementById('participantName').value.trim();

            if (!participantName) {
                alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            const drawButton = document.getElementById('drawButton');
            drawButton.disabled = true;

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            showDrawAnimation();

            // åˆ©ç”¨å¯èƒ½ãªå¸­ç•ªå·ã‚’å–å¾—
            loadUsedSeats();
            const availableSeats = [];
            for (let i = 1; i <= currentSession.total_seats; i++) {
                if (!usedSeats.has(i)) {
                    availableSeats.push(i);
                }
            }

            if (availableSeats.length === 0) {
                alert('ã™ã¹ã¦ã®å¸­ãŒåŸ‹ã¾ã£ã¦ã„ã¾ã™');
                hideDrawAnimation();
                drawButton.disabled = false;
                return;
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ã«å¸­ã‚’é¸æŠ
            const randomIndex = Math.floor(Math.random() * availableSeats.length);
            const selectedSeat = availableSeats[randomIndex];

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¼”å‡ºï¼ˆ2ç§’é–“ï¼‰
            let counter = 0;
            const animationInterval = setInterval(() => {
                const randomNum = Math.floor(Math.random() * currentSession.total_seats) + 1;
                document.getElementById('rouletteNumber').textContent = randomNum;
                counter++;
                if (counter >= 20) {
                    clearInterval(animationInterval);
                    finalizeDraw(participantName, selectedSeat);
                }
            }, 100);
        }

        // ãã˜å¼•ãç¢ºå®š
        function finalizeDraw(participantName, seatNumber) {
            const assignment = {
                id: generateId(),
                session_id: currentSession.session_id,
                participant_name: participantName,
                seat_number: seatNumber,
                created_at: new Date().toISOString()
            };

            // å‰²ã‚Šå½“ã¦ä¿å­˜
            const assignments = getAssignments();
            assignments.push(assignment);
            saveAssignments(assignments);

            hideDrawAnimation();
            showResult(participantName, seatNumber);
            loadResults();

            // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
            document.getElementById('drawButton').disabled = false;
            document.getElementById('participantName').value = '';
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function showDrawAnimation() {
            document.getElementById('drawAnimation').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³éè¡¨ç¤º
        function hideDrawAnimation() {
            document.getElementById('drawAnimation').classList.remove('active');
        }

        // çµæœè¡¨ç¤º
        function showResult(name, seatNumber) {
            document.getElementById('resultName').textContent = name + ' ã•ã‚“';
            document.getElementById('resultSeatNumber').textContent = seatNumber;
            document.getElementById('resultCard').classList.add('active');
        }

        // ä½¿ç”¨æ¸ˆã¿å¸­ç•ªå·ã‚’èª­ã¿è¾¼ã¿
        function loadUsedSeats() {
            usedSeats.clear();
            const assignments = getAssignments();
            assignments.forEach(assignment => {
                if (assignment.session_id === currentSession.session_id) {
                    usedSeats.add(assignment.seat_number);
                }
            });
        }

        // çµæœãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        function loadResults() {
            const assignments = getAssignments();
            const sessionResults = assignments.filter(item => item.session_id === currentSession.session_id);

            const resultsList = document.getElementById('resultsList');
            
            if (sessionResults.length === 0) {
                resultsList.innerHTML = '<p class="empty-message">ã¾ã èª°ã‚‚ãã˜ã‚’å¼•ã„ã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            // å¸­ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆ
            sessionResults.sort((a, b) => a.seat_number - b.seat_number);

            resultsList.innerHTML = sessionResults.map(item => `
                <div class="result-item">
                    <span class="result-item-name">${escapeHtml(item.participant_name)}</span>
                    <span class="result-item-seat">å¸­ ${item.seat_number}</span>
                </div>
            `).join('');

            // ä½¿ç”¨æ¸ˆã¿å¸­ã‚’æ›´æ–°
            usedSeats.clear();
            sessionResults.forEach(item => {
                usedSeats.add(item.seat_number);
            });
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°é–‹å§‹
        function startPolling() {
            // æ—¢å­˜ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // 3ç§’ã”ã¨ã«çµæœã‚’æ›´æ–°
            pollingInterval = setInterval(() => {
                loadResults();
            }, 3000);
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°åœæ­¢
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢ã«æˆ»ã‚‹
        function backToSetup() {
            stopPolling();
            currentSession = null;
            usedSeats.clear();

            document.getElementById('drawScreen').classList.remove('active');
            document.getElementById('setupScreen').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
            document.getElementById('participantName').value = '';
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });

        // storage ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼ˆåŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¥ã‚¿ãƒ–ï¼‰
        window.addEventListener('storage', (e) => {
            if ((e.key === STORAGE_ASSIGNMENTS || e.key === STORAGE_SESSIONS) && currentSession) {
                loadResults();
            }
        });
    </script>
</body>
</html>
