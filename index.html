<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∏≠„Åè„ÅòÂºï„Åç„Ç¢„Éó„É™ - „É™„Ç¢„É´„Çø„Ç§„É†ÂÖ±Êúâ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* ÁîªÈù¢Âàá„ÇäÊõø„Åà */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* „Ç´„Éº„Éâ */
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            width: 100%;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: #4CAF50;
            color: white;
            width: auto;
            margin-left: 10px;
        }

        .btn-large {
            padding: 20px;
            font-size: 1.2rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Âå∫Âàá„ÇäÁ∑ö */
        .divider {
            text-align: center;
            color: white;
            margin: 20px 0;
            font-weight: 700;
        }

        /* „Çª„ÉÉ„Ç∑„Éß„É≥ÊÉÖÂ†± */
        .session-info {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .session-info h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .session-info p {
            margin: 5px 0;
        }

        /* ÊäΩÈÅ∏„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .draw-animation {
            display: none;
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .draw-animation.active {
            display: block;
        }

        .roulette {
            margin: 0 auto 20px;
            width: 200px;
            height: 200px;
            border: 8px solid #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }

        .roulette-number {
            font-size: 4rem;
            font-weight: 700;
            color: #667eea;
            animation: spin 0.1s linear infinite;
        }

        .animation-text {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 700;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes spin {
            from {
                transform: rotateY(0deg);
            }
            to {
                transform: rotateY(360deg);
            }
        }

        /* ÁµêÊûú„Ç´„Éº„Éâ */
        .result-card {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s;
        }

        .result-card.active {
            display: block;
        }

        .result-content h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .seat-number {
            font-size: 5rem;
            font-weight: 700;
            color: #764ba2;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .result-name {
            font-size: 1.5rem;
            color: #555;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ÁµêÊûú„É™„Çπ„Éà */
        .results-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .results-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-badge {
            background: #ff4444;
            color: white;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 50%, 100% {
                opacity: 1;
            }
            25%, 75% {
                opacity: 0.5;
            }
        }

        .results-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            animation: slideIn 0.3s;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item-name {
            font-weight: 700;
            color: #333;
        }

        .result-item-seat {
            font-size: 1.5rem;
            font-weight: 700;
            color: #764ba2;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }

        .notice strong {
            display: block;
            margin-bottom: 5px;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 600px) {
            header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
            }

            .seat-number {
                font-size: 3.5rem;
            }

            .roulette {
                width: 150px;
                height: 150px;
            }

            .roulette-number {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé≤ Â∏≠„Åè„ÅòÂºï„Åç„Ç¢„Éó„É™</h1>
            <p class="subtitle">„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏Áâà</p>
        </header>

        <div class="notice">
            <strong>‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ†Ö</strong>
            „Åì„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„ÅØ„Éñ„É©„Ç¶„Ç∂„ÅÆ„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇÂêå„Åò„Éñ„É©„Ç¶„Ç∂„ÉªÂêå„Åò„Éá„Éê„Ç§„Çπ„Åß„ÅÆ„Åø„Éá„Éº„Çø„ÅåÂÖ±Êúâ„Åï„Çå„Åæ„Åô„ÄÇË§áÊï∞„Éá„Éê„Ç§„Çπ„Åß„ÅÆÂÖ±Êúâ„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
        </div>

        <!-- „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê„ÉªÂèÇÂä†ÁîªÈù¢ -->
        <div id="setupScreen" class="screen active">
            <div class="card">
                <h2>Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„Çí‰ΩúÊàê</h2>
                <div class="form-group">
                    <label for="sessionName">„Çª„ÉÉ„Ç∑„Éß„É≥Âêç</label>
                    <input type="text" id="sessionName" placeholder="‰æã: 2025Âπ¥Â∫¶ Á¨¨1Âõû„Éü„Éº„ÉÜ„Ç£„É≥„Ç∞" />
                </div>
                <div class="form-group">
                    <label for="totalSeats">Â∏≠„ÅÆÊï∞</label>
                    <input type="number" id="totalSeats" min="2" max="100" value="10" />
                </div>
                <button class="btn btn-primary" onclick="createSession()">„Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê</button>
            </div>

            <div class="divider">„Åæ„Åü„ÅØ</div>

            <div class="card">
                <h2>Êó¢Â≠ò„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥„Å´ÂèÇÂä†</h2>
                <div class="form-group">
                    <label for="sessionId">„Çª„ÉÉ„Ç∑„Éß„É≥ID</label>
                    <input type="text" id="sessionId" placeholder="„Çª„ÉÉ„Ç∑„Éß„É≥ID„ÇíÂÖ•Âäõ" />
                </div>
                <button class="btn btn-secondary" onclick="joinSession()">„Çª„ÉÉ„Ç∑„Éß„É≥ÂèÇÂä†</button>
            </div>
        </div>

        <!-- „Åè„ÅòÂºï„ÅçÁîªÈù¢ -->
        <div id="drawScreen" class="screen">
            <div class="session-info">
                <h2 id="currentSessionName"></h2>
                <p>„Çª„ÉÉ„Ç∑„Éß„É≥ID: <strong id="currentSessionId"></strong></p>
                <p>Â∏≠Êï∞: <strong id="currentTotalSeats"></strong></p>
                <button class="btn btn-small btn-copy" onclick="copySessionId()">üìã ID„Çí„Ç≥„Éî„Éº</button>
            </div>

            <div class="card">
                <h2>„Åè„ÅòÂºï„Åç„ÇíÂÆüË°å</h2>
                <div class="form-group">
                    <label for="participantName">ÂêçÂâç</label>
                    <input type="text" id="participantName" placeholder="„ÅÇ„Å™„Åü„ÅÆÂêçÂâç„ÇíÂÖ•Âäõ" />
                </div>
                <button class="btn btn-primary btn-large" onclick="drawSeat()" id="drawButton">
                    üéØ „Åè„Åò„ÇíÂºï„Åè
                </button>
            </div>

            <!-- ÊäΩÈÅ∏„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ -->
            <div id="drawAnimation" class="draw-animation">
                <div class="roulette">
                    <div class="roulette-number" id="rouletteNumber">?</div>
                </div>
                <p class="animation-text">ÊäΩÈÅ∏‰∏≠...</p>
            </div>

            <!-- ÁµêÊûúË°®Á§∫ -->
            <div id="resultCard" class="result-card">
                <div class="result-content">
                    <h2>üéâ „ÅÇ„Å™„Åü„ÅÆÂ∏≠Áï™Âè∑</h2>
                    <div class="seat-number" id="resultSeatNumber">-</div>
                    <p class="result-name" id="resultName"></p>
                </div>
            </div>

            <!-- „É™„Ç¢„É´„Çø„Ç§„É†ÁµêÊûú„É™„Çπ„Éà -->
            <div class="results-section">
                <h2>üìä ÊäΩÈÅ∏ÁµêÊûú <span class="live-badge">LIVE</span></h2>
                <div id="resultsList" class="results-list">
                    <p class="empty-message">„Åæ„Å†Ë™∞„ÇÇ„Åè„Åò„ÇíÂºï„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="backToSetup()">‚Üê „Çª„ÉÉ„Ç∑„Éß„É≥ÈÅ∏Êäû„Å´Êàª„Çã</button>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentSession = null;
        let pollingInterval = null;
        let usedSeats = new Set();

        // LocalStorage „Ç≠„Éº
        const STORAGE_SESSIONS = 'lottery_sessions';
        const STORAGE_ASSIGNMENTS = 'lottery_assignments';

        // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£: „É©„É≥„ÉÄ„É†„Å™ID„ÇíÁîüÊàê
        function generateId() {
            return 'sess_' + Math.random().toString(36).substring(2, 15);
        }

        // LocalStorage Êìç‰Ωú
        function getSessions() {
            const data = localStorage.getItem(STORAGE_SESSIONS);
            return data ? JSON.parse(data) : [];
        }

        function saveSessions(sessions) {
            localStorage.setItem(STORAGE_SESSIONS, JSON.stringify(sessions));
        }

        function getAssignments() {
            const data = localStorage.getItem(STORAGE_ASSIGNMENTS);
            return data ? JSON.parse(data) : [];
        }

        function saveAssignments(assignments) {
            localStorage.setItem(STORAGE_ASSIGNMENTS, JSON.stringify(assignments));
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥‰ΩúÊàê
        function createSession() {
            const sessionName = document.getElementById('sessionName').value.trim();
            const totalSeats = parseInt(document.getElementById('totalSeats').value);

            if (!sessionName) {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (totalSeats < 2 || totalSeats > 100) {
                alert('Â∏≠„ÅÆÊï∞„ÅØ2„Äú100„ÅÆÁØÑÂõ≤„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const sessionId = generateId();
            const session = {
                id: sessionId,
                session_id: sessionId,
                session_name: sessionName,
                total_seats: totalSeats,
                status: 'active',
                created_at: new Date().toISOString()
            };

            // „Çª„ÉÉ„Ç∑„Éß„É≥‰øùÂ≠ò
            const sessions = getSessions();
            sessions.push(session);
            saveSessions(sessions);

            currentSession = session;
            showDrawScreen();
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÂèÇÂä†
        function joinSession() {
            const sessionId = document.getElementById('sessionId').value.trim();

            if (!sessionId) {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            const sessions = getSessions();
            const session = sessions.find(s => s.session_id === sessionId);

            if (session) {
                currentSession = session;
                showDrawScreen();
            } else {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü\n\nID: ' + sessionId);
            }
        }

        // „Åè„ÅòÂºï„ÅçÁîªÈù¢„ÇíË°®Á§∫
        function showDrawScreen() {
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('drawScreen').classList.add('active');

            document.getElementById('currentSessionName').textContent = currentSession.session_name;
            document.getElementById('currentSessionId').textContent = currentSession.session_id;
            document.getElementById('currentTotalSeats').textContent = currentSession.total_seats;

            // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞„ÇíÈñãÂßã
            startPolling();
            loadResults();
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ID„Çí„Ç≥„Éî„Éº
        function copySessionId() {
            const sessionId = currentSession.session_id;
            navigator.clipboard.writeText(sessionId).then(() => {
                alert('„Çª„ÉÉ„Ç∑„Éß„É≥ID„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ');
            }).catch(err => {
                prompt('„Çª„ÉÉ„Ç∑„Éß„É≥ID„Çí„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', sessionId);
            });
        }

        // „Åè„ÅòÂºï„ÅçÂÆüË°å
        async function drawSeat() {
            const participantName = document.getElementById('participantName').value.trim();

            if (!participantName) {
                alert('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            const drawButton = document.getElementById('drawButton');
            drawButton.disabled = true;

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈñãÂßã
            showDrawAnimation();

            // Âà©Áî®ÂèØËÉΩ„Å™Â∏≠Áï™Âè∑„ÇíÂèñÂæó
            loadUsedSeats();
            const availableSeats = [];
            for (let i = 1; i <= currentSession.total_seats; i++) {
                if (!usedSeats.has(i)) {
                    availableSeats.push(i);
                }
            }

            if (availableSeats.length === 0) {
                alert('„Åô„Åπ„Å¶„ÅÆÂ∏≠„ÅåÂüã„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô');
                hideDrawAnimation();
                drawButton.disabled = false;
                return;
            }

            // „É©„É≥„ÉÄ„É†„Å´Â∏≠„ÇíÈÅ∏Êäû
            const randomIndex = Math.floor(Math.random() * availableSeats.length);
            const selectedSeat = availableSeats[randomIndex];

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊºîÂá∫Ôºà2ÁßíÈñìÔºâ
            let counter = 0;
            const animationInterval = setInterval(() => {
                const randomNum = Math.floor(Math.random() * currentSession.total_seats) + 1;
                document.getElementById('rouletteNumber').textContent = randomNum;
                counter++;
                if (counter >= 20) {
                    clearInterval(animationInterval);
                    finalizeDraw(participantName, selectedSeat);
                }
            }, 100);
        }

        // „Åè„ÅòÂºï„ÅçÁ¢∫ÂÆö
        function finalizeDraw(participantName, seatNumber) {
            const assignment = {
                id: generateId(),
                session_id: currentSession.session_id,
                participant_name: participantName,
                seat_number: seatNumber,
                created_at: new Date().toISOString()
            };

            // Ââ≤„ÇäÂΩì„Å¶‰øùÂ≠ò
            const assignments = getAssignments();
            assignments.push(assignment);
            saveAssignments(assignments);

            hideDrawAnimation();
            showResult(participantName, seatNumber);
            loadResults();

            // „Éú„Çø„É≥„ÇíÂÜçÊúâÂäπÂåñ
            document.getElementById('drawButton').disabled = false;
            document.getElementById('participantName').value = '';
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
        function showDrawAnimation() {
            document.getElementById('drawAnimation').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
        }

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÈùûË°®Á§∫
        function hideDrawAnimation() {
            document.getElementById('drawAnimation').classList.remove('active');
        }

        // ÁµêÊûúË°®Á§∫
        function showResult(name, seatNumber) {
            document.getElementById('resultName').textContent = name + ' „Åï„Çì';
            document.getElementById('resultSeatNumber').textContent = seatNumber;
            document.getElementById('resultCard').classList.add('active');
        }

        // ‰ΩøÁî®Ê∏à„ÅøÂ∏≠Áï™Âè∑„ÇíË™≠„ÅøËæº„Åø
        function loadUsedSeats() {
            usedSeats.clear();
            const assignments = getAssignments();
            assignments.forEach(assignment => {
                if (assignment.session_id === currentSession.session_id) {
                    usedSeats.add(assignment.seat_number);
                }
            });
        }

        // ÁµêÊûú„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
        function loadResults() {
            const assignments = getAssignments();
            const sessionResults = assignments.filter(item => item.session_id === currentSession.session_id);

            const resultsList = document.getElementById('resultsList');
            
            if (sessionResults.length === 0) {
                resultsList.innerHTML = '<p class="empty-message">„Åæ„Å†Ë™∞„ÇÇ„Åè„Åò„ÇíÂºï„ÅÑ„Å¶„ÅÑ„Åæ„Åõ„Çì</p>';
                return;
            }

            // Â∏≠Áï™Âè∑È†Ü„Å´„ÇΩ„Éº„Éà
            sessionResults.sort((a, b) => a.seat_number - b.seat_number);

            resultsList.innerHTML = sessionResults.map(item => `
                <div class="result-item">
                    <span class="result-item-name">${escapeHtml(item.participant_name)}</span>
                    <span class="result-item-seat">Â∏≠ ${item.seat_number}</span>
                </div>
            `).join('');

            // ‰ΩøÁî®Ê∏à„ÅøÂ∏≠„ÇíÊõ¥Êñ∞
            usedSeats.clear();
            sessionResults.forEach(item => {
                usedSeats.add(item.seat_number);
            });
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ÈñãÂßã
        function startPolling() {
            // Êó¢Â≠ò„ÅÆ„Éù„Éº„É™„É≥„Ç∞„ÇíÂÅúÊ≠¢
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // 3Áßí„Åî„Å®„Å´ÁµêÊûú„ÇíÊõ¥Êñ∞
            pollingInterval = setInterval(() => {
                loadResults();
            }, 3000);
        }

        // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞ÂÅúÊ≠¢
        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        // „Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÁîªÈù¢„Å´Êàª„Çã
        function backToSetup() {
            stopPolling();
            currentSession = null;
            usedSeats.clear();

            document.getElementById('drawScreen').classList.remove('active');
            document.getElementById('setupScreen').classList.add('active');
            document.getElementById('resultCard').classList.remove('active');
            document.getElementById('participantName').value = '';
        }

        // HTML„Ç®„Çπ„Ç±„Éº„Éó
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„Å´„Éù„Éº„É™„É≥„Ç∞ÂÅúÊ≠¢
        window.addEventListener('beforeunload', () => {
            stopPolling();
        });

        // storage „Ç§„Éô„É≥„Éà„Åß„É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúüÔºàÂêå„Åò„Éñ„É©„Ç¶„Ç∂„ÅÆÂà•„Çø„ÉñÔºâ
        window.addEventListener('storage', (e) => {
            if ((e.key === STORAGE_ASSIGNMENTS || e.key === STORAGE_SESSIONS) && currentSession) {
                loadResults();
            }
        });
    </script>
</body>
</html>
